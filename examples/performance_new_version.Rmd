---
title: "R Notebook"
output:
  word_document: default
  html_document:
    df_print: paged
---

TODO: basically, contrib_distrib does not have 'up_to' and 'after' for every single entry. This also goes for nav as well. We need both of these to have both for every single fund. That way when it matches up it all comes together nicely.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r libraries}
library('knitr')
library('kableExtra')
library('AZASRS')
library('tidyverse')
library('ggthemes')
library('ggpubr')
library('tinytex')
library(zoo)
options(scipen=999)
tbl_out <- function(data) {
  data %>% 
    kable("pandoc", digits = 2, format.args = list(big.mark=',')) %>% 
    kable_styling("hover", full_width = FALSE)
}

tbl_out_f <- function(data) {
  head(data %>% filter(pm_fund_id == 'Aplo8'), 10) 
    # kable("pandoc", digits = 2, format.args = list(big.mark=',')) %>% 
    # kable_styling("hover", full_width = FALSE)
}
```

## Load data
```{r load_data}
valdate = value_date()
next_qtr_date = next_quarter()
nav_daily = get_pm_nav_daily() %>%
  mutate(effective_date = as.Date(effective_date, format = '%Y-%m-%d')) %>%
  filter(effective_date > '1900-01-01')
cash_flow_daily = get_pm_cash_flow_daily() %>%
  mutate(effective_date = as.Date(effective_date, format = '%Y-%m-%d')) %>%
  filter(effective_date > '1900-01-01')
ssbt_composite_daily = ssbt_composite_bor_daily() %>%
  mutate(effective_date = as.Date(effective_date, format = '%Y-%m-%d')) %>%
  filter(effective_date > '1900-01-01')
pm_f_i = pm_fund_info()
```

## Summarize Contrubtions & Distributions  
#### Grouped by Fund and whether it is before or after value date
```{r}
contrib_distrib = cash_flow_daily %>%
  mutate(valdate = if_else(effective_date <= valdate, 'up_to', 'after')) %>%
  group_by(pm_fund_id, valdate) %>%
  summarize(contributions = -1*sum(contributions), distributions = -1*sum(distributions))
contrib_distrib_singles_up_to = contrib_distrib %>% 
  filter(valdate == 'up_to') %>%
  group_by(pm_fund_id) %>% 
  summarize(n = n())
# These are funds that have 'after' values
contrib_distrib_singles_after = contrib_distrib %>% 
  filter(valdate == 'after') %>%
  group_by(pm_fund_id) %>% 
  summarize(n = n())
contrib_distrib_singles_opposite = contrib_distrib_singles_up_to %>% 
  anti_join(contrib_distrib_singles_after, by = 'pm_fund_id') %>%
  mutate(valdate = 'after', contributions = 0, distributions = 0)

contrib_distrib = bind_rows(contrib_distrib, 
                            contrib_distrib_singles_opposite) %>% 
  select(-n)

#contrib_distrib %>% tbl_out()
```


## Merge Value and Cash Flows  
#### Merged by Fund and before/after value date  
**Note** `after` and `up_to` are named properly for `contrib_distrib` but for `nav` the `up_to` really means `on` but the convention was used in order to join the data.
```{r}
nav = nav_daily %>%
  filter(effective_date >= valdate) %>%
  mutate(valdate = if_else(effective_date > valdate, 'after', 'up_to')) %>%
  group_by(pm_fund_id, valdate) %>%
  summarize(nav = sum(nav))
nav[is.na(nav)] = 0
nav_singles_up_to = nav %>% 
  filter(valdate == 'up_to') %>%
  group_by(pm_fund_id) %>% 
  summarize(n = n())
# These are funds that have 'after' values
nav_singles_after = nav %>% 
  filter(valdate == 'after') %>%
  group_by(pm_fund_id) %>% 
  summarize(n = n())
nav_singles_opposite = nav_singles_up_to %>% 
  anti_join(nav_singles_after, by = 'pm_fund_id') %>%
  mutate(valdate = 'after', nav = 0)
nav = bind_rows(nav, nav_singles_opposite) %>% select(-n)

nav_cf = contrib_distrib %>%
  left_join(nav, by = c('pm_fund_id', 'valdate')) %>%
  arrange(pm_fund_id, valdate) %>%
  left_join(pm_f_i, by = 'pm_fund_id')
nav_cf[is.na(nav_cf)] = 0
#nav_cf %>% tbl_out()
```


## Assigning proper values for NAV after Value Date  
#### This requires splitting up data `up_to` and `after`  
Ending NAV is decided by Value Date. If the latest NAV reporting is at the end of the previous quarter it will need to be adjusted by adding the subsequent cash flow. If the NAV has been reported for the next quarter it shall be used as the ending NAV.
```{r}
nav_cf_up_to = nav_cf %>%
  filter(valdate == 'up_to') %>%
  group_by(pm_fund_id) %>%
  summarize(contributions_up_to = sum(contributions),
            distributions_up_to = sum(distributions),
            nav_up_to = sum(nav))

nav_cf_after = nav_cf %>%
  mutate(nav = if_else(valdate == 'after' & nav == 0,
                sum(nav), nav)) %>%
  filter(valdate == 'after') %>%
  group_by(pm_fund_id) %>%
  summarize(contributions_after = sum(contributions),
            distributions_after = sum(distributions),
            nav_after = sum(nav))

nav_cf_joined = bind_rows(nav_cf_up_to, nav_cf_after)
nav_cf_joined[is.na(nav_cf_joined)] = 0
#nav_cf_joined %>% tbl_out()
```


## Aggregate Funds and Calculate Unrealized Gain/Loss  
```{r}
total_fund_value = ssbt_composite_daily %>%
  filter(ssbt_composite_id == 'ASRSA001',
         effective_date == valdate) %>%
  select(ending_market_value) %>%
  pull()

nav_cf_fund = nav_cf_joined %>%
  group_by(pm_fund_id) %>%
  summarize(contributions_up_to = sum(contributions_up_to),
            distributions_up_to = sum(distributions_up_to),
            contributions_after = sum(contributions_after),
            distributions_after = sum(distributions_after),
            nav_up_to = sum(nav_up_to),
            nav_after = sum(nav_after)) %>%
  mutate(unrealized_gain_loss_up_to = 
           nav_up_to - distributions_up_to - contributions_up_to,
         unrealized_gain_loss_after = 
           nav_after - distributions_after - contributions_after - nav_up_to,
         pct_of_total_fund = nav_after / total_fund_value) %>%
  left_join(pm_f_i, by = 'pm_fund_id')

#nav_cf_fund %>% tbl_out()
```

```{r}
calc_date_window_year = function(effective_date, roll_back_years){
  # Result will be # of years back
  max_date = max(effective_date)
  roll_back_date = max_date - months(roll_back_years * 12)
  effective_window = if_else(effective_date <= roll_back_date, FALSE, TRUE)
  return(effective_window)
}

### Need to add nav at valdate
### then if one exists after, new calc for irr (separate) - if none after valdate, nothing goes here.


#nav_daily_cf_daily %>% tbl_out()
```


```{r}
nav_cf_fund %>%
  group_by(pm_fund_portfolio) %>%
  summarize_if(is.numeric, sum) %>%
  mutate(contributions = contributions_up_to + contributions_after, 
         distributions = distributions_up_to + distributions_after,
         net = contributions + distributions,
         dpi = distributions / contributions) %>%
  select(pm_fund_portfolio, contributions, distributions, dpi, net)
```





## Transposes table to look like previous report (hold off here)
```{r}
nav_cf_rollup = nav_cf_fund %>%
  select(pm_fund_id, contributions_up_to, contributions_after, distributions_up_to, distributions_after, nav_up_to, nav_after, unrealized_gain_loss_up_to, unrealized_gain_loss_after) %>%
  mutate(nav_start = 0) %>%
  gather(metric, value, -pm_fund_id) %>%
  arrange(pm_fund_id)
nav_cf_rollup %>% tbl_out()
```









## Aggregate Funds by Portfolio and Calculate Unrealized Gain/Loss  
```{r}
nav_cf_portfolio_rollup = nav_cf_fund %>%
  group_by(pm_fund_portfolio) %>%
  summarize(contributions_up_to = sum(contributions_up_to),
            distributions_up_to = sum(distributions_up_to),
            contributions_after = sum(contributions_after),
            distributions_after = sum(distributions_after),
            nav_up_to = sum(nav_up_to),
            nav_after = sum(nav_after)) %>%
  mutate(unrealized_gain_loss_up_to = nav_up_to - distributions_up_to - contributions_up_to,
         unrealized_gain_loss_after = nav_after - distributions_after - contributions_after - nav_up_to)
nav_cf_portfolio_rollup %>% tbl_out()
```


## Filter by Specific Portfolio and Begin Calculating Tables  
```{r}
nav_cf_rollup = nav_cf_fund %>%
  select(pm_fund_id, contributions_up_to, contributions_after, distributions_up_to, distributions_after, nav_up_to, nav_after, unrealized_gain_loss_up_to, unrealized_gain_loss_after) %>%
  gather(metric, value, -pm_fund_id) %>%
  arrange(pm_fund_id)

fund_up_to = tibble(metric = c('nav_start', 'contributions_up_to', 'distributions_up_to', 'unrealized_gain_loss_up_to', 'nav_up_to' )) %>% 
  left_join(nav_cf_rollup, by = 'metric') %>%
  arrange(pm_fund_id)
fund_up_to[is.na(fund_up_to)] = 0

fund_after = tibble(metric = c('nav_up_to', 'contributions_after', 'distributions_after', 'unrealized_gain_loss_after', 'nav_after' )) %>%
  left_join(nav_cf_rollup, by = 'metric') %>%
  arrange(pm_fund_id)


### change to bind_rows ... or something like that?
portfolio_joined = bind_cols(fund_up_to, fund_after) %>%
  mutate('metric' = c('Beginning NAV', 'Contributions', 'Distributions', 'Unrealized Gain/Loss', 'Ending NAV')) %>%
  rename(Lockdown = value, Post_Lockdown = value1) %>%
  select(-metric1)
portfolio_joined %>% tbl_out()



```










```{r}
#Percent of total fund
total_fund = ssbt_composite_daily %>%
  filter(ssbt_composite_id == 'ASRSA001',
         effective_date == valdate)
ending_navs = portfolio_joined %>% filter(metric == 'Ending NAV')

pct_of_total_fund = tibble(metric = 'percent-of_total_fund',
                             Lockdown = ending_navs$Lockdown/total_fund$ending_market_value,
                             Post_Lockdown = ending_navs$Post_Lockdown/total_fund$ending_market_value)

portfolio_joined = bind_rows(portfolio_joined, pct_of_total_fund)
portfolio_joined %>% tbl_out()
```





# Need to handle for unfunded and commit NA values

```{r}
#Unfunded (fixed, needed to equal valdate, not less than or equal)
unfunded = nav_daily %>%
  filter(!is.na(unfunded)) %>%
  filter(effective_date == valdate) %>%
  group_by(pm_fund_portfolio) %>%
  summarize(unfunded = sum(unfunded))
unfunded %>% tbl_out()
```




```{r}
# rolling 12s
rolling_12s = cash_flow_daily %>% 
  filter(effective_date >= (lubridate::today() - months(12))) %>%
  group_by(pm_fund_portfolio) %>%
  summarize(contributions = sum(contributions),
            distributions = sum(distributions), 
            net_cash_flow = contributions + distributions)
rolling_12s %>% tbl_out()
```



```{r}
contrib_distrib_chart = cash_flow_daily %>% 
  filter(pm_fund_portfolio == portfolio_name) %>%
  mutate(yr_qtr = zoo::as.Date(zoo::as.yearqtr(effective_date))) %>%
  group_by(yr_qtr) %>%
  summarize(contributions = sum(contributions),
            distributions = sum(distributions), 
            net_cash_flow = contributions + distributions) %>%
  gather(distrib_type, value, -yr_qtr)

ggplot(contrib_distrib_chart, aes(x=yr_qtr, y=value, col=distrib_type)) +
  geom_line() + 
  theme_minimal()
```

# Group and summarize IRRs
## Base this off of valdate (everything is quarter before, year before, etc.)
```{r}
zoo_data = cash_flow_daily %>% 
  filter(pm_fund_portfolio == portfolio_name) %>%
  group_by(effective_date) %>%
  summarize(cash_flow = sum(cash_flow)) %>%
  tsbox::ts_zoo()
asrsMethods::irr.z(zoo_data)
```

```{r}
a = get_pm_cash_flow_daily()
b = get_pm_nav_daily()
calc_tvpi_df(a, b, grouping_var = 'pm_fund_id')
calc_tvpi_df(a, b, grouping_var = 'pm_fund_category')
```



# Add additional calculations

## TVPI
```{r}
tvpi_df = calc_tvpi_df(cash_flow_daily, nav_daily)
tvpi_df %>% tbl_out_f()
```
