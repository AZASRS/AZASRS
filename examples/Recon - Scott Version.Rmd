---
title: "Recon - Scott Version"
author: "Scott"
date: "February 22, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
library('tidyverse')
library('lubridate')
library('AZASRS')
```

```{r constants}
con = AZASRS_DATABASE_CONNECTION() # allows passing of database object for lazy querying
fytd.bgn <- ymd("2018-07-01")
fytd.end <- ymd("2018-09-30")
```

```{r load_MYSS_data, message=FALSE, warning=FALSE}
daily.data.account = daily_data_account()
daily.data.composite = daily_data_composite()
monthly.data.account = monthly_data_account()
monthly.data.composite = monthly_data_composite()
  

daily.data = daily.data.account %>% rename(daily_return = account_daily_return) %>%
 bind_rows(daily.data.composite %>% 
             rename(daily_return = composite_daily_return)) %>%
 filter(effective_date >= fytd.bgn, effective_date <= fytd.end) %>%
 rename(Date = effective_date,
       b.mv = beginning_market_value,
       e.mv = ending_market_value,
       cf = net_cash_flow,
       r.day = daily_return,
       b.day = benchmark_daily_return) %>%
  select(Date, Name, ID, b.mv, e.mv, cf, r.day, b.day) %>%
  mutate(Date = ymd(Date, tz = "America/Los_Angeles"))

#daily.data[is.na(daily.data)] = 0 


monthly.data = monthly.data.account %>% 
  rename(monthly_return = account_monthly_return,
         fiscal_ytd_return = account_fiscal_ytd_return) %>%
 bind_rows(monthly.data.composite %>% 
             rename(monthly_return = composite_monthly_return,
                    fiscal_ytd_return = composite_fiscal_ytd_return)) %>%
 filter(effective_date >= fytd.bgn, effective_date <= fytd.end) %>%
 rename(Date = effective_date,
       r.MTD = monthly_return,
       b.MTD = benchmark_monthly_return,
       r.FYTD = fiscal_ytd_return,
       b.FYTD = benchmark_fiscal_ytd_return) %>%
  select(Date, Name, ID, b.Name, r.MTD, b.MTD, r.FYTD, b.FYTD) %>%
  mutate(Date = ymd(Date, tz = "America/Los_Angeles"))

#monthly.data[is.na(monthly.data)] = 0 
# CHECK: PASS monthly.data and daily.data are accurate
```

```{r warning=FALSE}
comps = tbl_book_of_record_composite_daily(con)  %>%
  replace(is.na(.), 0) %>%
  group_by(ssbt_composite_info_id, effective_date) %>%
  summarize_if(is.numeric, sum)

accts = tbl_ssbt_composite_info_account_info(con) %>%
  left_join(tbl_book_of_record_account_daily(con), by = 'account_info_id') %>%
  replace(is.na(.), 0) %>%
  group_by(ssbt_composite_info_id, effective_date) %>%
  summarize_if(is.numeric, sum)

ca = comps %>%
  left_join(accts, by = c('ssbt_composite_info_id', 'effective_date'), suffix = c('.comps', '.accts')) %>%
  mutate(beginning_market_value_delta = (beginning_market_value.comps - beginning_market_value.accts),
         ending_market_value_delta = (ending_market_value.comps - ending_market_value.accts),
         net_cash_flow_delta = (net_cash_flow.comps - net_cash_flow.accts),
         daily_return_delta = (daily_return.comps - daily_return.accts)) %>%
  left_join(tbl_ssbt_composite_info(con) %>% 
              select(ssbt_composite_info_id, ssbt_composite_id, asset_class_id), 
            by = 'ssbt_composite_info_id') %>%
  left_join(tbl_asset_class(con), by = 'asset_class_id')
ca
```

