---
title: "IRR Reconciliation"
date: "11/13/2019"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('AZASRS')
library('purrr')
library('tidyverse')
library('lubridate')
options(scipen = 999)
```


```{r message = FALSE}
end_date = '2019-06-30'
years_to_lag = c(0.25, 0.5, 1, 3, 5)

all_db_irrs = tibble()
for(years_back in years_to_lag){
  print(paste('Number of years looking back:', as.character(years_back)))

  if(years_back >= 1){
    start_date = AZASRS::calc_previous_year_qtr(end_date = end_date, years = years_back)
  } else {
    start_date = AZASRS::calc_previous_year_qtr(end_date = end_date, qtrs = 4*years_back)
  }

  db_irrs = build_lagged_pm_metrics(pm_fund_portfolio, pm_fund_category, pm_fund_id,
                                    start_date = start_date, end_date = end_date, itd=FALSE,
                                    n_qtrs = years_back*4)
  all_db_irrs = bind_rows(all_db_irrs, db_irrs)
}

# Add ITD
db_irrs_itd = build_lagged_pm_metrics(pm_fund_portfolio, pm_fund_category, pm_fund_id,
                                  start_date = start_date, end_date = end_date, itd=TRUE,
                                  n_qtrs = 4) %>%
  filter(itd == TRUE)

all_db_irrs = bind_rows(all_db_irrs, db_irrs_itd)

all_db_irrs %>% head()
```

```{r}
all_db_irrs %>% 
```


```{r}
data_directory = './reconciliation_data/'
cont = AzureStor::blob_container(Sys.getenv('ASRS_BLOB_PM_RECONCILIATION'), key = Sys.getenv('ASRS_BLOB_KEY'))
all_files = AzureStor::list_blobs(cont) %>% filter(!str_detect(name, '/'))
AzureStor::multidownload_blob(cont, '*.csv', data_directory, overwrite = TRUE)

csv_irrs_raw = tibble()
for(file in all_files$name){
  tmp = read_csv(paste0(data_directory, file)) 
  tmp = tmp %>%
    select(`Client Grouping 1`, Quarter = `3 Month IRR`, `6 Month IRR`,
                   `1 Year IRR`, `3 Year IRR`, `5 Year IRR`, `7 Year IRR`, `10 Year IRR`, `ITD IRR`) %>%
    drop_na(`Client Grouping 1`) %>%
    mutate_all(as.character)
  csv_irrs_raw = bind_rows(csv_irrs_raw, tmp)
}

remove_parenthesis = function(x){
  y = gsub('\\)', '', x)
  z = gsub('\\(', '-', y)
  as.numeric(z)
}
# remove parentheses
csv_irrs_ids = csv_irrs_raw %>% select(`Client Grouping 1`)
csv_irrs = csv_irrs_raw %>% 
  select(-`Client Grouping 1`) %>% 
  mutate_all(remove_parenthesis) %>% 
  bind_cols(csv_irrs_ids) %>%
  select(`Client Grouping 1`, everything())

csv_irrs %>% head()
```


```{r}
df1 = db_irrs %>% mutate(source = 'database')
df2 = csv_irrs %>% mutate(source = 'csv') %>% rename(pm_fund_id = `Client Grouping 1`)
df = bind_rows(df1, df2)

diffs = df %>%
  gather(key = time_period, value = 'irr', -fund_id, -source) %>%
  mutate(irr = if_else(source == 'csv', -1*irr/100, irr)) %>%
  group_by(fund_id, time_period) %>%
  summarize(diff = sum(irr)) %>%
  arrange(-diff)

diffs %>% left_join(db_irrs_unnested %>% select(fund_id, time_period, end_date, start_date), by = c('fund_id', 'time_period')) %>%
  write_csv('irr_diffs.csv')
```

```{r}
diff
```


```{r}
df %>% dplyr::filter(fund_id == 'K3') 
```

```{r}
cf_df %>% dplyr::filter(pm_fund_id == 'Lindn4')
```
