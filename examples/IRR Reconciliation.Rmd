---
title: "IRR Reconciliation"
date: "11/13/2019"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('AZASRS')
library('purrr')
library('tidyverse')
library('lubridate')
options(scipen = 999)
```


```{r}
pmfi = get_pm_fund_info() %>% select(pm_fund_id)
ending_date = get_value_date()
years_quarters = tibble(years    = c(0, 0, 1, 3, 5, 7, 10, 15), 
                       quarters  = c(1, 2, 0, 0, 0, 0, 0, 0),
                       time_period = factor(c('3 Month IRR', 
                                            '6 Month IRR',
                                            '1 Year IRR', 
                                            '3 Year IRR', 
                                            '5 Year IRR',
                                            '7 Year IRR',
                                            '10 Year IRR',
                                            'ITD IRR'), 
                                          ordered = TRUE,
                                          levels = c(
                                            '3 Month IRR', 
                                            '6 Month IRR',
                                            '1 Year IRR', 
                                            '3 Year IRR', 
                                            '5 Year IRR',
                                            '7 Year IRR',
                                            '10 Year IRR',
                                            'ITD IRR')
                                          )) %>%
  mutate(end_date = ending_date,
         start_date = calc_previous_year_qtr(ending_date, years, quarters))

nav_df = get_pm_nav_daily()
cf_df = get_pm_cash_flow_daily()

con = AZASRS::AZASRS_DATABASE_CONNECTION()

prep_irr_cash_flow = function(fund_id, start_date, end_date){
  
  #con = AZASRS::AZASRS_DATABASE_CONNECTION()
  
  nav_min_date = nav_df %>% filter(pm_fund_id == fund_id) %>% select(effective_date) %>% pull() %>% min()
  
  nav = nav_df %>% #get_pm_nav_daily(con = con, return_tibble = FALSE) %>% 
    #mutate(min_date = nav_min_date) %>%
    filter(pm_fund_id == fund_id,  
           effective_date == start_date | effective_date == end_date) %>%
    select(pm_fund_id, effective_date, nav) %>%
    mutate(cash_flow_mod = 0) %>%
    as_tibble()
  
  if(nrow(nav) < 2){return(tibble(pm_fund_id = fund_id, effective_date = start_date, cash_flow_mod = 0))}
  
  min_date = min(nav$effective_date)
  if(min_date != start_date){return(tibble(pm_fund_id = fund_id, effective_date = start_date, cash_flow_mod = 0))}
  
  cf = cf_df %>% #get_pm_cash_flow_daily(con = con, return_tibble = FALSE) %>% 
    filter(pm_fund_id == fund_id, effective_date > start_date, effective_date < end_date) %>%
    select(pm_fund_id, effective_date, cash_flow) %>%
    mutate(cash_flow_mod = 0) %>%
    as_tibble()
  
  df = bind_rows(nav, cf)
  df[is.na(df)] = 0
  
  
  final_df = df %>%
    arrange(effective_date) %>%
    mutate(cash_flow_mod = nav + cash_flow,
           cash_flow_mod = if_else(effective_date == min_date, 
                                   -1*(cash_flow_mod), cash_flow_mod)) %>%
    group_by(pm_fund_id, effective_date) %>%
    summarize(cash_flow_mod = sum(cash_flow_mod))
  return(final_df)
}

call_irr_map = function(fund_id, start_date, end_date){
  cf_prep = prep_irr_cash_flow(fund_id, start_date, end_date) %>%
    arrange(effective_date)
  if(nrow(cf_prep) < 2){ return(NA) }
  irr = calc_irr(cf_prep$cash_flow_mod, cf_prep$effective_date)
  return(irr)
}

prep_df = tibble()
for(i in 1:nrow(pmfi)){
  fund_vec = rep(pmfi$pm_fund_id[i], nrow(years_quarters))
  tmp_df = years_quarters %>% mutate(pm_fund_id = fund_vec)
  prep_df = bind_rows(prep_df, tmp_df)
}

db_irrs_unnested = prep_df %>% 
  rename(fund_id = pm_fund_id) %>%
  mutate(irr = pmap(list(fund_id, start_date, end_date), .f = call_irr_map)) %>% 
  unnest() 

db_irrs = db_irrs_unnested %>%
  select(fund_id, time_period, irr) %>%
  spread(key = time_period, value = irr)

db_irrs[is.na(db_irrs)] = 0 #to match csvs
```


```{r}
data_directory = './reconciliation_data/'

cont = AzureStor::blob_container(Sys.getenv('ASRS_BLOB_PM_RECONCILIATION'), key = Sys.getenv('ASRS_BLOB_KEY'))
all_files = AzureStor::list_blobs(cont)
AzureStor::multidownload_blob(cont, '*.csv', data_directory, overwrite = TRUE)

csv_irrs = tibble()
for(file in all_files$name){
  tmp = read_csv(paste0(data_directory, file)) %>%
    select(`Client Grouping 1`, `3 Month IRR`, `6 Month IRR`,
                   `1 Year IRR`, `3 Year IRR`, `5 Year IRR`, `7 Year IRR`, `10 Year IRR`, `ITD IRR`) %>%
    drop_na(`Client Grouping 1`)
  csv_irrs = bind_rows(csv_irrs, tmp)
}

```


```{r}
df1 = db_irrs %>% mutate(source = 'database')
df2 = csv_irrs %>% mutate(source = 'csv') %>% rename(fund_id = `Client Grouping 1`) %>% filter()
df = bind_rows(df1, df2)

diffs = df %>%
  gather(key = time_period, value = 'irr', -fund_id, -source) %>%
  mutate(irr = if_else(source == 'csv', -1*irr/100, irr)) %>%
  group_by(fund_id, time_period) %>%
  summarize(diff = sum(irr)) %>%
  arrange(-diff)

diffs %>% left_join(db_irrs_unnested %>% select(fund_id, time_period, end_date, start_date), by = c('fund_id', 'time_period')) %>%
  write_csv('irr_diffs.csv')
```

```{r}
diff
```


```{r}
df %>% dplyr::filter(fund_id == 'K3') 
```

```{r}
cf_df %>% dplyr::filter(pm_fund_id == 'Lindn4')
```


