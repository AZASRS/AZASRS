---
title: "Composite Check"
author: "Scott Stoltzman"
date: "October 11, 2018"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library('AZASRS')
library('tidyverse')
library('dbplyr')
library('knitr')
library('kableExtra')
con = AZASRS_DATABASE_CONNECTION()
composite_to_check = 'ASRSA060'
```

## Example 1 - US Large Cap Equity - Check against total - Using individual tables

### Process:  

We are looking to compare tables: `book_of_record_composite_daily` and `book_of_record_account_daily` to `ending_market_value` is consistent across tables. This shows aggregating by account will lead to the same output as utilizing the composite data. Therefore, you can feel comfortable creating your own composites by selecting accounts and aggregating them. 

#### Assumptions:  

Must use absolute value to check cash flows because they have been turned into "negative" values when they start within the data set.


#### Composite Steps

  1. Pull data from `book_of_record_composite_daily`
  2. Join with `composite_info` to get `ssbt_composite_ids`
  3. Clean up `NA` values by replacing all with `0`
  4. Take absolute values of `ending_market_value` to cancel out the "negatives" imposed in the imported data
  5. Group and sum the data by `ssbt_composite_id`

#### Account Steps

  1. Pull data from `tbl_ssbt_composite_info`
  2. Join with `tbl_ssbt_composite_info_account_info` to get `account_info_id` associated with each `ssbt_composite_id`
  3. Join with `tbl_book_of_record_account_daily` to get `ending_market_value` of each `account_info_id`
  4. Clean up `NA` values by replacing all with `0`
  5. Take absolute values of ending_market_value to cancel out the "negatives" imposed in the imported data
  6. Group and sum the data by ssbt_composite_id

#### Checking Differences  

  1. Join data by `ssbt_composite_id` from steps created above
  2. Find differences between the sum of the absolute value of `ending_market_values`
  3. Display percentage differences as compared to both Composites and Accounts

---

#### Account Totals 
```{r}
comps = tbl_book_of_record_composite_daily(con = con) %>%
  left_join(ssbt_composite_info(con = con, return_tibble = FALSE), by = 'ssbt_composite_info_id') %>%
  as_tibble() %>%
  replace(., is.na(.), 0) %>%
  mutate(ending_market_value = abs(ending_market_value)) %>%
  group_by(ssbt_composite_id) %>%
  mutate(ending_market_value = abs(ending_market_value)) %>%
  summarize(sumFunds = sum(ending_market_value))

comps %>% kable() %>% kable_styling() %>%
  scroll_box(width = "40%", height = "300px")
```


#### Composite totals
```{r}
accts = tbl_ssbt_composite_info(con) %>%
  left_join(tbl_ssbt_composite_info_account_info(con), by = 'ssbt_composite_info_id') %>%
  select(ssbt_composite_id, account_info_id) %>%
  left_join(tbl_book_of_record_account_daily(con), by = 'account_info_id') %>%
  as_tibble() %>%
  replace(., is.na(.), 0) %>%
  mutate(ending_market_value = abs(ending_market_value)) %>%
  group_by(ssbt_composite_id) %>%
  summarize(sumFunds = sum(ending_market_value))

accts %>% kable() %>% kable_styling() %>%
  scroll_box(width = "40%", height = "300px")
```

#### Difference between composite and accounts
```{r}
check = comps %>% 
  left_join(accts, by = 'ssbt_composite_id', suffix = c(".composites", ".accounts")) %>%
  mutate(Delta = sumFunds.composites - sumFunds.accounts,
         Delta_pct_composites = 100*Delta/sumFunds.composites,
         Delta_pct_accounts = 100*Delta/sumFunds.accounts)

check %>% kable() %>% kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```


